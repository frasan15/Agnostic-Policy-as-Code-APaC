{
    "terraform": [
        {
            "required_version": ">= 0.14.0",
            "required_providers": [
                {
                    "openstack": {
                        "source": "terraform-provider-openstack/openstack",
                        "version": "~> 1.53.0"
                    }
                }
            ]
        }
    ],
    "resource": [
        {
            "openstack_networking_network_v2": {
                "network_1": {
                    "name": "network1",
                    "admin_state_up": "true"
                }
            }
        },
        {
            "openstack_networking_subnet_v2": {
                "subnet_1": {
                    "name": "subnet1",
                    "network_id": "${openstack_networking_network_v2.network_1.id}",
                    "cidr": "192.168.111.0/24",
                    "ip_version": 4
                }
            }
        },
        {
            "openstack_networking_secgroup_v2": {
                "secgroup_1": {
                    "name": "secgroup_1",
                    "description": "Expose port 80"
                }
            }
        },
        {
            "openstack_networking_secgroup_rule_v2": {
                "secgroup_rule_1": {
                    "direction": "ingress",
                    "ethertype": "IPv4",
                    "protocol": "tcp",
                    "port_range_min": 80,
                    "port_range_max": 80,
                    "remote_ip_prefix": "0.0.0.0/0",
                    "security_group_id": "${openstack_networking_secgroup_v2.secgroup_1.id}"
                }
            }
        },
        {
            "openstack_networking_secgroup_v2": {
                "secgroup_2": {
                    "name": "secgroup_2",
                    "description": "Expose port 22"
                }
            }
        },
        {
            "openstack_networking_secgroup_rule_v2": {
                "secgroup_rule_2": {
                    "direction": "ingress",
                    "ethertype": "IPv4",
                    "protocol": "tcp",
                    "port_range_min": 22,
                    "port_range_max": 22,
                    "remote_ip_prefix": "0.0.0.0/0",
                    "security_group_id": "${openstack_networking_secgroup_v2.secgroup_2.id}"
                }
            }
        },
        {
            "openstack_networking_port_v2": {
                "port_server_1": {
                    "name": "port_server_1",
                    "network_id": "${openstack_networking_network_v2.network_1.id}",
                    "admin_state_up": "true",
                    "security_group_ids": [
                        "${openstack_networking_secgroup_v2.secgroup_1.id}"
                    ],
                    "fixed_ip": [
                        {
                            "subnet_id": "${openstack_networking_subnet_v2.subnet_1.id}",
                            "ip_address": "192.168.111.10"
                        }
                    ]
                }
            }
        },
        {
            "openstack_networking_port_v2": {
                "port_server_2": {
                    "name": "port_server_2",
                    "network_id": "${openstack_networking_network_v2.network_1.id}",
                    "admin_state_up": "true",
                    "security_group_ids": [
                        "${openstack_networking_secgroup_v2.secgroup_2.id}"
                    ],
                    "fixed_ip": [
                        {
                            "subnet_id": "${openstack_networking_subnet_v2.subnet_1.id}",
                            "ip_address": "192.168.111.11"
                        }
                    ]
                }
            }
        },
        {
            "openstack_compute_instance_v2": {
                "server_1": {
                    "depends_on": [
                        "${openstack_networking_secgroup_rule_v2.secgroup_rule_1}"
                    ],
                    "name": "server1",
                    "flavor_name": "gx1.2c4r",
                    "image_id": "db1bc18e-81e3-477e-9067-eecaa459ec33",
                    "network": [
                        {
                            "port": "${openstack_networking_port_v2.port_server_1.id}"
                        }
                    ],
                    "security_groups": [
                        "${openstack_networking_secgroup_v2.secgroup_1.name}"
                    ],
                    "key_pair": "MySecondKey",
                    "provisioner": [
                        {
                            "local-exec": {
                                "command": "echo '\\n' >> server_ids.txt; echo '${self.id}' >> server_ids.txt"
                            }
                        }
                    ]
                }
            }
        },
        {
            "openstack_compute_instance_v2": {
                "server_2": {
                    "depends_on": [
                        "${openstack_networking_secgroup_rule_v2.secgroup_rule_2}"
                    ],
                    "name": "server2",
                    "flavor_name": "gx1.2c4r",
                    "image_id": "db1bc18e-81e3-477e-9067-eecaa459ec33",
                    "network": [
                        {
                            "port": "${openstack_networking_port_v2.port_server_2.id}"
                        }
                    ],
                    "security_groups": [
                        "${openstack_networking_secgroup_v2.secgroup_2.name}"
                    ],
                    "key_pair": "MySecondKey"
                }
            }
        },
        {
            "openstack_networking_router_v2": {
                "router_1": {
                    "name": "router1",
                    "admin_state_up": "true",
                    "external_network_id": "730cb16e-a460-4a87-8c73-50a2cb2293f9"
                }
            }
        },
        {
            "openstack_networking_router_interface_v2": {
                "router_interface_1": {
                    "router_id": "${openstack_networking_router_v2.router_1.id}",
                    "subnet_id": "${openstack_networking_subnet_v2.subnet_1.id}"
                }
            }
        },
        {
            "openstack_networking_floatingip_v2": {
                "myip": {
                    "depends_on": [
                        "${openstack_compute_instance_v2.server_1}",
                        "${openstack_networking_router_interface_v2.router_interface_1}"
                    ],
                    "pool": "ntnu-internal",
                    "port_id": "${openstack_networking_port_v2.port_server_1.id}"
                }
            }
        },
        {
            "null_resource": {
                "delete_file": {
                    "depends_on": [
                        "${local.server_instance_ids}"
                    ],
                    "provisioner": [
                        {
                            "local-exec": {
                                "command": "echo '' > server_ids.txt"
                            }
                        }
                    ]
                }
            }
        }
    ],
    "locals": [
        {
            "depends_on": [
                "${openstack_networking_secgroup_rule_v2.secgroup_rule_1}",
                "${openstack_networking_floatingip_v2.myip}"
            ],
            "secgroup_info": {
                "name": "${openstack_networking_secgroup_v2.secgroup_1.name}",
                "description": "${openstack_networking_secgroup_v2.secgroup_1.description}",
                "id": "${openstack_networking_secgroup_v2.secgroup_1.id}",
                "rules": [
                    {
                        "direction": "${openstack_networking_secgroup_rule_v2.secgroup_rule_1.direction}",
                        "ethertype": "${openstack_networking_secgroup_rule_v2.secgroup_rule_1.ethertype}",
                        "protocol": "${openstack_networking_secgroup_rule_v2.secgroup_rule_1.protocol}",
                        "port_range_min": "${openstack_networking_secgroup_rule_v2.secgroup_rule_1.port_range_min}",       
                        "port_range_max": "${openstack_networking_secgroup_rule_v2.secgroup_rule_1.port_range_max}",       
                        "remote_ip_prefix": "${openstack_networking_secgroup_rule_v2.secgroup_rule_1.remote_ip_prefix}"    
                    }
                ]
            },
            "float_ip": "${openstack_networking_floatingip_v2.myip}"
        },
        {
            "server_instance_ids": "${[for id in split(\"\\n\", data.local_file.server_ids_file.content) : id if id != \"\"]}"
        }
    ],
    "data": [
        {
            "local_file": {
                "server_ids_file": {
                    "depends_on": [
                        "${openstack_compute_instance_v2.server_1}"
                    ],
                    "filename": "server_ids.txt"
                }
            }
        },
        {
            "openstack_compute_instance_v2": {
                "server_info": {
                    "id": "${openstack_compute_instance_v2.server_1.id}"
                }
            }
        },
        {
            "openstack_compute_instance_v2": {
                "server_info_2": {
                    "id": "9733b23b-26d6-4078-8666-5e65da9e3cea"
                }
            }
        },
        {
            "openstack_networking_network_v2": {
                "network": {
                    "depends_on": [
                        "${openstack_networking_network_v2.network_1}"
                    ],
                    "name": "network1"
                }
            }
        },
        {
            "openstack_networking_secgroup_v2": {
                "secgroup": {
                    "depends_on": [
                        "${openstack_networking_secgroup_rule_v2.secgroup_rule_1}"
                    ],
                    "name": "secgroup_1"
                }
            }
        },
        {
            "openstack_networking_subnet_v2": {
                "subnet_1": {
                    "depends_on": [
                        "${openstack_networking_subnet_v2.subnet_1}"
                    ],
                    "subnet_id": "${openstack_networking_subnet_v2.subnet_1.id}"
                }
            }
        },
        {
            "openstack_networking_router_v2": {
                "router": {
                    "depends_on": [
                        "${openstack_networking_router_v2.router_1}"
                    ],
                    "name": "router1"
                }
            }
        }
    ]
}